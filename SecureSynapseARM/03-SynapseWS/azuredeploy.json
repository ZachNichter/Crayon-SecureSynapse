{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "createSynapseWS": {
            "type": "string",
            "defaultValue": "true",
            "metadata": {
                "description": "Create a new Synapse workspace?"
            }
        },
        "dataLakeAccount": {
            "type": "string",
            "defaultValue": "securesynapseadls",
            "metadata": {
                "description": "Account name for built in Synapse data lake"
            }
        },
        "dataLakeAccountContainer": {
            "type": "string",
            "defaultValue": "filestore",
            "metadata": {
                "description": "Container in data lake"
            }
        },
        "sqlAdminLogin": {
            "type": "string",
            "defaultValue": "sqladminuser",
            "metadata": {
                "description": "Synapse SQL administrator account name"
            }
        },
        "sqlAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "description"
            }
        },
        "synapseWSName": {
            "type": "string",
            "defaultValue": "securedSynapseWS",
            "metadata": {
                "description": "Name of the workspace"
            }
        },
        "allowAllConnections": {
            "type": "string",
            "defaultValue": "true",
            "metadata": {
                "description": "Is Synapse workspace accessible from public internet?"
            }
        },
        "createNewStorageAccount": {
            "type": "string",
            "defaultValue": "true",
            "metadata": {
                "description": "Should a new storage account be created?"
            }
        }
    },
    "functions": [],
    "variables": {
        "location": "[resourceGroup().location]",
        "subscriptionId": "[subscription().subscriptionId]",
        "defaultStorageAccountURL": "[concat('https://',parameters('dataLakeAccount'), '.dfs.core.windows.net')]",
        "webEndpoint": "[concat('https://web.azuresynapse.net?workspace=%2fsubscriptions%2f', variables('subscriptionId'),'%2fresourceGroups%2f', variables('location'),'%2fproviders%2fMicrosoft.Synapse%2fworkspaces%2f', parameters('synapseWSName'))]",
        "devEndpoint": "[concat('https://', parameters('synapseWSName'), '.dev.azuresynapse.net')]",
        "onDemandEndpoint": "[concat(parameters('synapseWSName'), '-ondemand.sql.azuresynapse.net')]",
        "sqlEndpoint": "[concat(parameters('synapseWSName'), '.sql.azuresynapse.net')]"
    },
    "resources": [
        {
            "condition": "[bool(parameters('createSynapseWS'))]",
            "name": "[parameters('synapseWSName')]",
            "type": "Microsoft.Synapse/workspaces",
            "apiVersion": "2020-12-01",
            "tags": {},
            "location": "[variables('location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "defaultDataLakeStorage": {
                    "accountUrl": "[variables('defaultStorageAccountURL')]",
                    "filesystem": "[parameters('dataLakeAccountContainer')]"
                },
                "sqlAdministratorLoginPassword": "[parameters('sqlAdminPassword')]",
                "managedResourceGroupName": "", //this can be blank or null - autogenerated
                "sqlAdministratorLogin": "[parameters('sqlAdminLogin')]",
                // "virtualNetworkProfile": {
                // "computeSubnetId": "string"     //subnet used for compute in workspace
                // },
                "connectivityEndpoints": {
                    "web": "[variables('webEndpoint')]",
                    "dev": "[variables('devEndpoint')]",
                    "sqlOnDemand": "[variables('onDemandEndpoint')]",
                    "sql": "[variables('sqlEndpoint')]"
                },
                "managedVirtualNetwork": "default",
                 "managedVirtualNetworkSettings": {
                    "preventDataExfiltration": "[bool('false')]",
                    // "linkedAccessCheckOnTargetResource": "boolean",
                    "allowedAadTenantIdsForLinking": [
                    ]
                },
                "resources": [
                    {
                        "condition": "[parameters('allowAllConnections')]",
                        "apiVersion": "2021-03-01",
                        "dependsOn": [
                            "[concat('Microsoft.Synapse/workspaces/', parameters('synapseWSName'))]"
                        ],
                        "location": "[variables('location')]",
                        "name": "allowAll",
                        "properties": {
                            "startIpAddress": "0.0.0.0",
                            "endIpAddress": "255.255.255.255"
                        },
                        "type": "firewallrules"
                    },
                    {
                        "apiVersion": "2021-03-01",
                        // "apiVersion": "2019-06-01-preview",
                        "dependsOn": [
                            "[concat('Microsoft.Synapse/workspaces/', parameters('synapseWSName'))]"
                        ],
                        "location": "[variables('location')]",
                        "name": "default",
                        "properties": {
                            "grantSqlControlToManagedIdentity": {
                                "desiredState": "Enabled"
                            }
                        },
                        "type": "managedIdentitySqlControlSettings"
                    }
                ]
            }
        }, 
        {
            "condition": "[bool(parameters('createNewStorageAccount'))]",
            "name": "[parameters('dataLakeAccount')]",
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2018-02-01",
            "tags": {},
            "location": "[variables('location')]",
            "kind": "StorageV2",
            "sku": {
                "name": "Premium_LRS",
                "tier": "Premium"
            },
            "properties": {
                "accessTier": "hot",
                "supportsHttpsTrafficOnly": "[bool('true')]",
                "isHnsEnabled": "[bool('true')]"
            },
            "resources": [
                {
                    "condition": "[bool(parameters('createNewStorageAccount'))]",
                    "name": "[concat('default/', parameters('dataLakeAccountContainer'))]",
                    "type": "blobServices/containers",
                    "apiVersion": "2018-02-01",
                    "properties": {
                        "publicAccess": "None"
                    },
                    "dependsOn": [
                        "[concat('Microsoft.Storage/storageAccounts/', parameters('dataLakeAccount'))]"
                    ]
                }
            ]
        }
    ],
    "outputs": {
        "subscriptionId": {
            "type": "string",
            "value": "[variables('subscriptionId')]"
        },
        "resourceGroupName": {
            "type": "string",
            "value": "[resourceGroup().name]"
        },
        "resourceGroupLocation": {
            "type": "string",
            "value": "[variables('location')]"
        },
        "synapseWorkspaceName": {
            "type": "string",
            "value": "[parameters('synapseWSName')]"
        },
        "webEndpoint": {
            "type": "string",
            "value": "[variables('webEndpoint')]"
        },
        "devEndpoint": {
            "type": "string",
            "value": "[variables('devEndpoint')]"
        },
        "indemandEndpoint": {
            "type": "string",
            "value": "[variables('ondemandEndpoint')]"
        },
        "sqlEndpoint": {
            "type": "string",
            "value": "[variables('sqlEndpoint')]"
        }
    }
}